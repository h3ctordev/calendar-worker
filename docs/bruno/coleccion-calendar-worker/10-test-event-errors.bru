meta {
  name: 10 - Test Errores Creaci√≥n Eventos
  type: http
  seq: 10
}

post {
  url: {{base_url}}/calendar/events
  body: json
  auth: none
}

headers {
  Content-Type: application/json
  x-user-id: {{user_id}}
}

body:json {
  {
    "calendar_id": "{{test_calendar_id}}",
    "summary": "{{test_summary}}",
    "description": "{{test_description}}",
    "event_type": "{{test_event_type}}",
    "start": {
      "dateTime": "{{test_start_time}}",
      "timeZone": "America/Santiago"
    },
    "end": {
      "dateTime": "{{test_end_time}}",
      "timeZone": "America/Santiago"
    },
    "attendees": [
      { "email": "{{test_attendee_email}}" }
    ]
  }
}

script:pre-request {
  // Verificar que user_id est√© definido para tests b√°sicos
  const userId = bru.getEnvVar("user_id");
  if (!userId && bru.getVar("error_scenario") !== "missing_user_header") {
    throw new Error("user_id no est√° definido en las variables de entorno");
  }

  // Configurar escenario de error a probar
  const errorScenario = bru.getVar("error_scenario") || "invalid_event_type";

  console.log("üß™ Probando escenario de error:", errorScenario);

  // Configurar datos base v√°lidos
  const now = new Date();
  const baseStartTime = new Date(now.getTime() + (2 * 60 * 60 * 1000)); // 2 horas
  const baseEndTime = new Date(baseStartTime.getTime() + (60 * 60 * 1000)); // 1 hora despu√©s

  switch(errorScenario) {
    case "missing_user_header":
      console.log("‚ùå Test: Header x-user-id faltante");
      // Remover el header x-user-id
      req.setHeader("x-user-id", "");
      bru.setVar("test_calendar_id", "primary");
      bru.setVar("test_summary", "Test Event");
      bru.setVar("test_event_type", "meeting");
      bru.setVar("test_start_time", baseStartTime.toISOString());
      bru.setVar("test_end_time", baseEndTime.toISOString());
      bru.setVar("test_attendee_email", "test@example.com");
      break;

    case "invalid_calendar":
      console.log("‚ùå Test: Calendario inexistente");
      bru.setVar("test_calendar_id", "nonexistent@group.calendar.google.com");
      bru.setVar("test_summary", "Test Event");
      bru.setVar("test_event_type", "meeting");
      bru.setVar("test_start_time", baseStartTime.toISOString());
      bru.setVar("test_end_time", baseEndTime.toISOString());
      bru.setVar("test_attendee_email", "test@example.com");
      break;

    case "empty_summary":
      console.log("‚ùå Test: Summary vac√≠o");
      bru.setVar("test_calendar_id", "primary");
      bru.setVar("test_summary", "");
      bru.setVar("test_event_type", "meeting");
      bru.setVar("test_start_time", baseStartTime.toISOString());
      bru.setVar("test_end_time", baseEndTime.toISOString());
      bru.setVar("test_attendee_email", "test@example.com");
      break;

    case "invalid_event_type":
      console.log("‚ùå Test: Tipo de evento inv√°lido");
      bru.setVar("test_calendar_id", "primary");
      bru.setVar("test_summary", "Test Event");
      bru.setVar("test_event_type", "invalid_type_123");
      bru.setVar("test_start_time", baseStartTime.toISOString());
      bru.setVar("test_end_time", baseEndTime.toISOString());
      bru.setVar("test_attendee_email", "test@example.com");
      break;

    case "invalid_dates":
      console.log("‚ùå Test: Fecha de fin anterior a inicio");
      bru.setVar("test_calendar_id", "primary");
      bru.setVar("test_summary", "Test Event");
      bru.setVar("test_event_type", "meeting");
      bru.setVar("test_start_time", baseEndTime.toISOString()); // Intercambiar fechas
      bru.setVar("test_end_time", baseStartTime.toISOString());
      bru.setVar("test_attendee_email", "test@example.com");
      break;

    case "invalid_email":
      console.log("‚ùå Test: Email de asistente inv√°lido");
      bru.setVar("test_calendar_id", "primary");
      bru.setVar("test_summary", "Test Event");
      bru.setVar("test_event_type", "meeting");
      bru.setVar("test_start_time", baseStartTime.toISOString());
      bru.setVar("test_end_time", baseEndTime.toISOString());
      bru.setVar("test_attendee_email", "invalid-email-format");
      break;

    case "long_summary":
      console.log("‚ùå Test: Summary excesivamente largo");
      const longSummary = "A".repeat(1100); // Exceder l√≠mite de 1024
      bru.setVar("test_calendar_id", "primary");
      bru.setVar("test_summary", longSummary);
      bru.setVar("test_event_type", "meeting");
      bru.setVar("test_start_time", baseStartTime.toISOString());
      bru.setVar("test_end_time", baseEndTime.toISOString());
      bru.setVar("test_attendee_email", "test@example.com");
      break;

    case "past_date":
      console.log("‚ùå Test: Evento en el pasado");
      const pastStart = new Date(now.getTime() - (24 * 60 * 60 * 1000)); // Ayer
      const pastEnd = new Date(pastStart.getTime() + (60 * 60 * 1000));
      bru.setVar("test_calendar_id", "primary");
      bru.setVar("test_summary", "Past Event");
      bru.setVar("test_event_type", "meeting");
      bru.setVar("test_start_time", pastStart.toISOString());
      bru.setVar("test_end_time", pastEnd.toISOString());
      bru.setVar("test_attendee_email", "test@example.com");
      break;

    case "readonly_calendar":
      console.log("‚ùå Test: Calendario de solo lectura");
      // Usar un calendario t√≠picamente de solo lectura como holidays
      bru.setVar("test_calendar_id", "en.usa#holiday@group.v.calendar.google.com");
      bru.setVar("test_summary", "Test Holiday");
      bru.setVar("test_event_type", "reminder");
      bru.setVar("test_start_time", baseStartTime.toISOString());
      bru.setVar("test_end_time", baseEndTime.toISOString());
      bru.setVar("test_attendee_email", "test@example.com");
      break;

    default:
      console.log("‚ùå Test: Tipo de evento inv√°lido (default)");
      bru.setVar("test_calendar_id", "primary");
      bru.setVar("test_summary", "Test Event");
      bru.setVar("test_event_type", "invalid_type");
      bru.setVar("test_start_time", baseStartTime.toISOString());
      bru.setVar("test_end_time", baseEndTime.toISOString());
      bru.setVar("test_attendee_email", "test@example.com");
      break;
  }

  // Configurar descripci√≥n seg√∫n escenario
  bru.setVar("test_description", `Test de error: ${errorScenario}`);

  console.log("üìù Datos de prueba configurados");
  console.log("   Calendario:", bru.getVar("test_calendar_id"));
  console.log("   Tipo evento:", bru.getVar("test_event_type"));
  console.log("   Summary:", bru.getVar("test_summary").substring(0, 50) + "...");
}

script:post-response {
  const errorScenario = bru.getVar("error_scenario") || "invalid_event_type";

  console.log("Escenario probado:", errorScenario);
  console.log("Status:", res.getStatus());

  const body = res.getBody();

  // An√°lisis espec√≠fico por escenario
  if (res.getStatus() >= 400) {
    console.log("‚úÖ Error capturado correctamente");

    if (body.error) {
      console.log("üìù Mensaje:", body.error.message);

      // Mostrar detalles de validaci√≥n si existen
      if (body.error.details && body.error.details.validation_errors) {
        console.log("üîç Errores de validaci√≥n:");
        body.error.details.validation_errors.forEach((error, index) => {
          console.log(`   ${index + 1}. ${error.field}: ${error.message}`);
        });
      }

      // Mostrar informaci√≥n de permisos si existe
      if (body.error.details && body.error.details.required_permission) {
        console.log("üîí Permisos:");
        console.log("   Requerido:", body.error.details.required_permission);
        console.log("   Actual:", body.error.details.current_permission);
      }

      // An√°lisis espec√≠fico por tipo de error
      switch(errorScenario) {
        case "missing_user_header":
          console.log("‚úÖ Confirmado: Header x-user-id es obligatorio");
          break;
        case "invalid_calendar":
          console.log("‚úÖ Confirmado: Validaci√≥n de calendario funciona");
          break;
        case "empty_summary":
          console.log("‚úÖ Confirmado: Summary no puede estar vac√≠o");
          break;
        case "invalid_event_type":
          console.log("‚úÖ Confirmado: Validaci√≥n de tipos de evento funciona");
          break;
        case "invalid_dates":
          console.log("‚úÖ Confirmado: Validaci√≥n de fechas funciona");
          break;
        case "invalid_email":
          console.log("‚úÖ Confirmado: Validaci√≥n de emails funciona");
          break;
        case "long_summary":
          console.log("‚úÖ Confirmado: L√≠mite de longitud de summary funciona");
          break;
        case "past_date":
          console.log("‚ö†Ô∏è  Nota: Eventos pasados pueden ser v√°lidos en algunos casos");
          break;
        case "readonly_calendar":
          console.log("‚úÖ Confirmado: Validaci√≥n de permisos funciona");
          break;
      }
    }
  } else {
    console.log("‚ö†Ô∏è  Advertencia: Se esperaba un error pero la respuesta fue exitosa");
    console.log("   Esto puede indicar que la validaci√≥n no est√° funcionando correctamente");
  }

  // Verificar que no se filtren datos sensibles
  const responseText = JSON.stringify(body);
  if (responseText.includes("refresh_token") ||
      responseText.includes("client_secret") ||
      responseText.includes("access_token")) {
    console.log("üö® ADVERTENCIA: Posible filtraci√≥n de datos sensibles");
  } else {
    console.log("‚úÖ No se detectaron datos sensibles en la respuesta");
  }

  // Guardar resultado del test para an√°lisis
  bru.setVar(`error_test_${errorScenario}_status`, res.getStatus());
  bru.setVar(`error_test_${errorScenario}_passed`, res.getStatus() >= 400);
}

tests {
  test("Error responses have proper structure", function() {
    const body = res.getBody();
    if (res.getStatus() >= 400) {
      expect(body).to.have.property("error");
      expect(body.error).to.have.property("message");
    }
  });

  test("Error responses are JSON", function() {
    expect(res.getHeader("content-type")).to.contain("application/json");
  });

  test("No sensitive data in error response", function() {
    const responseText = JSON.stringify(res.getBody());
    expect(responseText).to.not.contain("refresh_token");
    expect(responseText).to.not.contain("client_secret");
    expect(responseText).to.not.contain("access_token");
  });

  test("Validation errors have correct structure", function() {
    const body = res.getBody();
    if (body.error && body.error.details && body.error.details.validation_errors) {
      body.error.details.validation_errors.forEach((error) => {
        expect(error).to.have.property("field");
        expect(error).to.have.property("message");
      });
    }
  });

  test("Missing header returns 401", function() {
    const errorScenario = bru.getVar("error_scenario");
    if (errorScenario === "missing_user_header") {
      expect(res.getStatus()).to.equal(401);
    }
  });

  test("Invalid calendar returns 404 or 403", function() {
    const errorScenario = bru.getVar("error_scenario");
    if (errorScenario === "invalid_calendar" || errorScenario === "readonly_calendar") {
      expect([403, 404]).to.include(res.getStatus());
    }
  });

  test("Validation errors return 400", function() {
    const errorScenario = bru.getVar("error_scenario");
    const validationScenarios = [
      "empty_summary", "invalid_event_type", "invalid_dates",
      "invalid_email", "long_summary"
    ];

    if (validationScenarios.includes(errorScenario)) {
      expect(res.getStatus()).to.equal(400);
    }
  });

  test("Permission errors return 403", function() {
    const errorScenario = bru.getVar("error_scenario");
    if (errorScenario === "readonly_calendar") {
      expect([403, 404]).to.include(res.getStatus());
    }
  });
}

docs {
  # Test de Errores en Creaci√≥n de Eventos

  Este endpoint especializado permite probar diferentes escenarios de error en la creaci√≥n de eventos para verificar el manejo correcto de validaciones, permisos y casos edge.

  ## Variables de Control

  Configura la variable `error_scenario` para probar diferentes escenarios de error:

  ### Errores de Autenticaci√≥n
  - `missing_user_header`: Sin header x-user-id (401)

  ### Errores de Validaci√≥n de Datos
  - `empty_summary`: Summary vac√≠o (400)
  - `invalid_event_type`: Tipo de evento no v√°lido (400)
  - `invalid_dates`: Fecha de fin anterior a inicio (400)
  - `invalid_email`: Email de asistente malformado (400)
  - `long_summary`: Summary excesivamente largo (400)

  ### Errores de Calendario y Permisos
  - `invalid_calendar`: Calendario inexistente (404)
  - `readonly_calendar`: Calendario de solo lectura (403)

  ### Errores de L√≥gica de Negocio
  - `past_date`: Evento programado en el pasado (puede ser v√°lido)

  ## Uso del Test

  ### Configurar Escenario
  ```javascript
  // En Variables de Colecci√≥n de Bruno
  bru.setVar("error_scenario", "invalid_event_type");
  ```

  ### Ejecutar Test
  Ejecuta el request "10 - Test Errores Creaci√≥n Eventos"

  ### Cambiar Escenario
  ```javascript
  bru.setVar("error_scenario", "empty_summary");
  ```
  Ejecuta nuevamente para probar diferente validaci√≥n

  ## Ejemplos de Respuestas de Error

  ### 400 - Datos Inv√°lidos
  ```json
  {
    "error": {
      "message": "Invalid request data.",
      "details": {
        "validation_errors": [
          {
            "field": "event_type",
            "message": "Invalid event type. Must be one of: meeting, presentation, workshop, etc."
          }
        ]
      }
    }
  }
  ```

  ### 401 - Sin Autenticaci√≥n
  ```json
  {
    "error": {
      "message": "Missing x-user-id header."
    }
  }
  ```

  ### 403 - Permisos Insuficientes
  ```json
  {
    "error": {
      "message": "Insufficient permissions to create events in this calendar.",
      "details": {
        "calendar_id": "readonly@group.calendar.google.com",
        "required_permission": "writer",
        "current_permission": "reader"
      }
    }
  }
  ```

  ### 404 - Calendario No Encontrado
  ```json
  {
    "error": {
      "message": "Calendar not found or not accessible.",
      "details": {
        "calendar_id": "nonexistent@group.calendar.google.com",
        "user_id": "usuario123"
      }
    }
  }
  ```

  ## Escenarios de Validaci√≥n Espec√≠ficos

  ### 1. Validaci√≥n de Tipos de Evento
  ```javascript
  bru.setVar("error_scenario", "invalid_event_type");
  ```
  **Verifica**: Que solo se acepten tipos de eventos v√°lidos
  **Esperado**: Error 400 con lista de tipos v√°lidos

  ### 2. Validaci√≥n de Fechas
  ```javascript
  bru.setVar("error_scenario", "invalid_dates");
  ```
  **Verifica**: Que la fecha de inicio sea anterior a la de fin
  **Esperado**: Error 400 con mensaje descriptivo

  ### 3. Validaci√≥n de Emails
  ```javascript
  bru.setVar("error_scenario", "invalid_email");
  ```
  **Verifica**: Formato correcto de emails de asistentes
  **Esperado**: Error 400 con detalles del email inv√°lido

  ### 4. L√≠mites de Longitud
  ```javascript
  bru.setVar("error_scenario", "long_summary");
  ```
  **Verifica**: Respeto de l√≠mites de caracteres (1024 para summary)
  **Esperado**: Error 400 con l√≠mite espec√≠fico

  ### 5. Validaci√≥n de Permisos
  ```javascript
  bru.setVar("error_scenario", "readonly_calendar");
  ```
  **Verifica**: Permisos de escritura en calendario
  **Esperado**: Error 403 con detalles de permisos

  ## Tests Automatizados

  ### Estructura de Respuestas
  - Todas las respuestas de error son JSON v√°lido
  - Campo `error.message` siempre presente
  - Estructura consistente de `validation_errors`

  ### C√≥digos de Estado
  - **400**: Errores de validaci√≥n de datos
  - **401**: Problemas de autenticaci√≥n
  - **403**: Problemas de autorizaci√≥n/permisos
  - **404**: Recursos no encontrados

  ### Seguridad
  - No filtraci√≥n de tokens o credenciales
  - Mensajes de error informativos pero seguros
  - Validaci√≥n de entrada robusta

  ## Casos de Uso para Testing

  ### 1. Testing de Regresi√≥n
  Ejecutar todos los escenarios para verificar que las validaciones siguen funcionando despu√©s de cambios

  ### 2. Validaci√≥n de API
  Confirmar que los c√≥digos de estado y mensajes son apropiados para cada tipo de error

  ### 3. Testing de Seguridad
  Verificar que no se filtran datos sensibles en respuestas de error

  ### 4. Documentaci√≥n de Errores
  Generar ejemplos reales de respuestas de error para documentaci√≥n

  ## Flujo de Testing Sistem√°tico

  ### Preparaci√≥n
  1. Asegurar que el usuario est√© autenticado (requests 02-03)
  2. Obtener lista de calendarios (request 04) para identificar permisos

  ### Ejecuci√≥n
  1. Configurar `error_scenario`
  2. Ejecutar request
  3. Verificar c√≥digo de estado esperado
  4. Analizar estructura de respuesta
  5. Cambiar a siguiente escenario

  ### Validaci√≥n Completa
  ```javascript
  const scenarios = [
    "missing_user_header", "invalid_calendar", "empty_summary",
    "invalid_event_type", "invalid_dates", "invalid_email",
    "long_summary", "readonly_calendar"
  ];

  scenarios.forEach(scenario => {
    bru.setVar("error_scenario", scenario);
    // Ejecutar request y verificar resultado
  });
  ```

  ## Variables de Resultado

  El script guarda resultados para an√°lisis posterior:
  - `error_test_[scenario]_status`: C√≥digo de estado recibido
  - `error_test_[scenario]_passed`: Si el test pas√≥ (true/false)

  ## Troubleshooting del Test

  ### Error inesperado exitoso (200/201)
  **Causa**: La validaci√≥n no est√° funcionando
  **Acci√≥n**: Revisar implementaci√≥n de validaciones

  ### Error de c√≥digo incorrecto
  **Causa**: Mapeo incorrecto de errores a c√≥digos HTTP
  **Acci√≥n**: Verificar manejo de excepciones

  ### Datos sensibles en respuesta
  **Causa**: Logging excesivo o filtraci√≥n
  **Acci√≥n**: Revisar redacci√≥n de informaci√≥n sensible

  Este sistema de testing de errores asegura que la API maneje correctamente todos los casos edge y proporcione retroalimentaci√≥n √∫til a los clientes.
}
