meta {
  name: 08 - Crear Evento en Calendario
  type: http
  seq: 8
}

post {
  url: {{base_url}}/calendar/events
  body: json
  auth: none
}

headers {
  Content-Type: application/json
  x-user-id: {{user_id}}
}

body:json {
  {
    "calendar_id": "primary",
    "summary": "Reuni√≥n de planificaci√≥n Q1",
    "description": "Planificaci√≥n estrat√©gica para el primer trimestre del a√±o",
    "location": "Sala de conferencias A - Piso 3",
    "event_type": "planning",
    "start": {
      "dateTime": "{{event_start_time}}",
      "timeZone": "America/Santiago"
    },
    "end": {
      "dateTime": "{{event_end_time}}",
      "timeZone": "America/Santiago"
    },
    "attendees": [
      { "email": "manager@example.com" },
      { "email": "lead@example.com" }
    ],
    "reminders": {
      "useDefault": false,
      "overrides": [
        { "method": "email", "minutes": 60 },
        { "method": "popup", "minutes": 15 }
      ]
    },
    "visibility": "default",
    "status": "confirmed"
  }
}

script:pre-request {
  // Verificar que user_id est√© definido
  if (!bru.getEnvVar("user_id") || bru.getEnvVar("user_id").trim() === "") {
    throw new Error("user_id no est√° definido en las variables de entorno");
  }

  // Configurar horarios del evento (1 hora desde ahora)
  const now = new Date();
  const startTime = new Date(now.getTime() + (2 * 60 * 60 * 1000)); // 2 horas desde ahora
  const endTime = new Date(startTime.getTime() + (90 * 60 * 1000)); // 1.5 horas de duraci√≥n

  bru.setVar("event_start_time", startTime.toISOString());
  bru.setVar("event_end_time", endTime.toISOString());

  console.log("üöÄ Creando evento para usuario:", bru.getEnvVar("user_id"));
  console.log("üìÖ Evento programado:", startTime.toLocaleString());
  console.log("‚è±Ô∏è  Duraci√≥n: 1.5 horas");

  // Verificar que el usuario est√© autenticado
  if (!bru.getVar("last_total_calendars")) {
    console.log("‚ö†Ô∏è  Recomendaci√≥n: Ejecutar '04 - Lista de Calendarios' primero para verificar permisos");
  }
}

script:post-response {
  console.log("Status:", res.getStatus());

  if (res.getStatus() === 201) {
    const body = res.getBody();
    console.log("‚úÖ Evento creado exitosamente!");
    console.log("üÜî ID del evento:", body.id);
    console.log("üìù Resumen:", body.summary);
    console.log("üìç Ubicaci√≥n:", body.location || "No especificada");
    console.log("üóìÔ∏è  Calendario:", body.calendar_info?.calendar_name || "Desconocido");
    console.log("üîó Enlace:", body.html_link);

    if (body.attendees && body.attendees.length > 0) {
      console.log("üë• Asistentes invitados:");
      body.attendees.forEach((attendee, index) => {
        console.log(`   ${index + 1}. ${attendee.email} (${attendee.responseStatus || 'pendiente'})`);
      });
    }

    if (body.event_metadata) {
      console.log("üè∑Ô∏è  Tipo de evento:", body.event_metadata.event_type);
      console.log("‚öôÔ∏è  Creado por worker:", body.event_metadata.created_by_worker);
    }

    // Guardar informaci√≥n del evento para otros requests
    bru.setVar("last_created_event_id", body.id);
    bru.setVar("last_created_event_link", body.html_link);

    console.log("\n‚ú® Puedes ver el evento en Google Calendar usando el enlace de arriba");

  } else {
    const body = res.getBody();
    console.log("‚ùå Error al crear evento:");
    console.log("Status:", res.getStatus());

    if (body.error) {
      console.log("Mensaje:", body.error.message);

      if (body.error.details && body.error.details.validation_errors) {
        console.log("Errores de validaci√≥n:");
        body.error.details.validation_errors.forEach((error, index) => {
          console.log(`  ${index + 1}. ${error.field}: ${error.message}`);
        });
      }

      if (body.error.details && body.error.details.required_permission) {
        console.log("Permisos requeridos:", body.error.details.required_permission);
        console.log("Permisos actuales:", body.error.details.current_permission);
        console.log("üí° Soluci√≥n: Usar un calendario donde tengas permisos de escritura");
      }
    }
  }
}

tests {
  test("Status code is 201 (Created)", function() {
    expect(res.getStatus()).to.equal(201);
  });

  test("Response is JSON", function() {
    expect(res.getHeader("content-type")).to.contain("application/json");
  });

  test("Response has required event fields", function() {
    const body = res.getBody();
    expect(body.id).to.exist;
    expect(body.summary).to.exist;
    expect(body.start).to.exist;
    expect(body.end).to.exist;
    expect(body.html_link).to.exist;
    expect(body.status).to.exist;
  });

  test("Event has calendar information", function() {
    const body = res.getBody();
    expect(body.calendar_info).to.exist;
    expect(body.calendar_info.calendar_id).to.equal("primary");
    expect(body.calendar_info.calendar_name).to.exist;
  });

  test("Event has worker metadata", function() {
    const body = res.getBody();
    expect(body.event_metadata).to.exist;
    expect(body.event_metadata.event_type).to.equal("planning");
    expect(body.event_metadata.created_by_worker).to.be.true;
    expect(body.event_metadata.worker_version).to.exist;
  });

  test("Event summary matches request", function() {
    const body = res.getBody();
    expect(body.summary).to.equal("Reuni√≥n de planificaci√≥n Q1");
  });

  test("Event has correct attendees", function() {
    const body = res.getBody();
    expect(body.attendees).to.be.an("array");
    expect(body.attendees.length).to.equal(2);

    const emails = body.attendees.map(a => a.email);
    expect(emails).to.include("manager@example.com");
    expect(emails).to.include("lead@example.com");
  });

  test("Event has reminders configured", function() {
    const body = res.getBody();
    expect(body.reminders).to.exist;
    expect(body.reminders.useDefault).to.be.false;
    expect(body.reminders.overrides).to.be.an("array");
    expect(body.reminders.overrides.length).to.equal(2);
  });

  test("Event dates are valid", function() {
    const body = res.getBody();
    const startDate = new Date(body.start.dateTime);
    const endDate = new Date(body.end.dateTime);

    expect(startDate.getTime()).to.be.lessThan(endDate.getTime());
    expect(body.start.timeZone).to.equal("America/Santiago");
    expect(body.end.timeZone).to.equal("America/Santiago");
  });

  test("Event is confirmed status", function() {
    const body = res.getBody();
    expect(body.status).to.equal("confirmed");
  });

  test("Creator and organizer are set", function() {
    const body = res.getBody();
    expect(body.creator).to.exist;
    expect(body.organizer).to.exist;
    expect(body.creator.self).to.be.true;
    expect(body.organizer.self).to.be.true;
  });
}

docs {
  # Crear Evento en Calendario

  Este endpoint permite crear un nuevo evento en un calendario espec√≠fico del usuario autenticado, con soporte para tipos de eventos, asistentes, recordatorios y recurrencia.

  ## Autenticaci√≥n requerida

  - `x-user-id` header: Identificador del usuario que debe existir en Cloudflare KV
  - **Permisos**: El usuario debe tener permisos de `writer` u `owner` en el calendario especificado

  ## Request Body

  ### Campos Requeridos
  - `calendar_id`: ID del calendario donde crear el evento
  - `summary`: T√≠tulo/resumen del evento (m√°ximo 1024 caracteres)
  - `start`: Fecha y hora de inicio
  - `end`: Fecha y hora de fin
  - `event_type`: Tipo de evento (ver tipos soportados)

  ### Campos Opcionales
  - `description`: Descripci√≥n detallada del evento
  - `location`: Ubicaci√≥n f√≠sica o virtual del evento
  - `attendees`: Lista de asistentes invitados
  - `reminders`: Configuraci√≥n de recordatorios
  - `visibility`: Visibilidad del evento (`default`, `public`, `private`, `confidential`)
  - `status`: Estado del evento (`confirmed`, `tentative`, `cancelled`)

  ## Tipos de Eventos Soportados

  ### Eventos de Trabajo
  - `meeting`: Reuniones de trabajo
  - `presentation`: Presentaciones
  - `workshop`: Talleres o capacitaciones
  - `conference-call`: Llamadas de conferencia
  - `review`: Sesiones de revisi√≥n
  - `planning`: Sesiones de planificaci√≥n
  - `standup`: Reuniones diarias de equipo

  ### Eventos Personales
  - `appointment`: Citas m√©dicas, legales, etc.
  - `personal`: Eventos personales generales
  - `family`: Eventos familiares
  - `social`: Eventos sociales
  - `travel`: Viajes o desplazamientos
  - `vacation`: Vacaciones o tiempo libre

  ### Eventos de Proyecto
  - `deadline`: Fechas l√≠mite importantes
  - `milestone`: Hitos del proyecto
  - `launch`: Lanzamientos de producto
  - `deployment`: Despliegues de sistemas

  ### Eventos Especiales
  - `all-day`: Eventos de todo el d√≠a
  - `recurring`: Eventos recurrentes
  - `reminder`: Recordatorios simples
  - `blocked-time`: Tiempo bloqueado sin detalles

  ## Respuesta esperada (201 Created)

  ```json
  {
    "id": "evento_abc123xyz",
    "status": "confirmed",
    "html_link": "https://www.google.com/calendar/event?eid=...",
    "created": "2024-03-15T08:30:00.000Z",
    "updated": "2024-03-15T08:30:00.000Z",
    "summary": "Reuni√≥n de planificaci√≥n Q1",
    "description": "Planificaci√≥n estrat√©gica...",
    "location": "Sala de conferencias A",
    "start": {
      "dateTime": "2024-03-15T09:00:00-03:00",
      "timeZone": "America/Santiago"
    },
    "end": {
      "dateTime": "2024-03-15T10:30:00-03:00",
      "timeZone": "America/Santiago"
    },
    "attendees": [
      {
        "email": "manager@example.com",
        "responseStatus": "needsAction"
      }
    ],
    "calendar_info": {
      "calendar_id": "primary",
      "calendar_name": "usuario@example.com",
      "calendar_color": "#9fc6e7"
    },
    "event_metadata": {
      "event_type": "planning",
      "created_by_worker": true,
      "worker_version": "2.1.0"
    }
  }
  ```

  ## Casos de error comunes

  ### 400 - Datos inv√°lidos
  ```json
  {
    "error": {
      "message": "Invalid request data.",
      "details": {
        "validation_errors": [
          {
            "field": "summary",
            "message": "Summary is required and cannot be empty"
          }
        ]
      }
    }
  }
  ```

  ### 401 - No autenticado
  ```json
  {
    "error": {
      "message": "Missing x-user-id header."
    }
  }
  ```

  ### 403 - Permisos insuficientes
  ```json
  {
    "error": {
      "message": "Insufficient permissions to create events in this calendar.",
      "details": {
        "calendar_id": "readonly@group.calendar.google.com",
        "required_permission": "writer",
        "current_permission": "reader"
      }
    }
  }
  ```

  ### 404 - Calendario no encontrado
  ```json
  {
    "error": {
      "message": "Calendar not found or not accessible.",
      "details": {
        "calendar_id": "invalid@group.calendar.google.com"
      }
    }
  }
  ```

  ## Variables din√°micas

  El script pre-request genera autom√°ticamente:
  - `event_start_time`: 2 horas desde el momento actual
  - `event_end_time`: 1.5 horas despu√©s del inicio

  ## Configuraci√≥n de prueba

  ### Calendario de destino
  Por defecto usa `"primary"` (calendario principal). Para probar otros calendarios:
  1. Ejecutar "04 - Lista de Calendarios" para ver calendarios disponibles
  2. Cambiar `calendar_id` en el body por un calendario con permisos `writer` u `owner`

  ### Tipos de evento para probar
  Cambia `event_type` en el body para probar diferentes tipos:
  ```json
  "event_type": "meeting"      // Reuni√≥n de trabajo
  "event_type": "workshop"     // Taller o capacitaci√≥n
  "event_type": "deadline"     // Fecha l√≠mite
  "event_type": "vacation"     // Vacaciones
  ```

  ### Asistentes personalizados
  Modifica el array `attendees` para probar con diferentes invitados:
  ```json
  "attendees": [
    { "email": "real-email@example.com" },
    { "email": "optional@example.com", "optional": true }
  ]
  ```

  ## Prerequisitos

  1. Usuario debe haber completado flujo OAuth con permisos de escritura
  2. Calendario destino debe existir y ser accesible
  3. Usuario debe tener rol `writer` u `owner` en el calendario
  4. Recomendado: Ejecutar "04 - Lista de Calendarios" para verificar permisos

  ## Flujo recomendado

  1. **Verificar permisos**: Ejecutar "04 - Lista de Calendarios"
  2. **Crear evento**: Ejecutar "08 - Crear Evento"
  3. **Verificar creaci√≥n**: Ejecutar "05 - Eventos de Hoy" para confirmar
  4. **Ver en Google**: Usar el `html_link` de la respuesta

  ## Notas t√©cnicas

  - Los horarios se calculan din√°micamente para evitar conflictos
  - El evento se crea 2 horas en el futuro por defecto
  - La duraci√≥n por defecto es de 1.5 horas
  - Los asistentes reciben invitaciones autom√°ticamente
  - El worker agrega metadatos para trazabilidad

  ## Troubleshooting

  ### Error de permisos
  **S√≠ntoma**: Error 403 con mensaje de permisos insuficientes
  **Soluci√≥n**: Usar un calendario donde tengas permisos `writer` u `owner`

  ### Error de validaci√≥n
  **S√≠ntoma**: Error 400 con validation_errors
  **Soluci√≥n**: Revisar el formato de fechas, emails y campos requeridos

  ### Usuario no encontrado
  **S√≠ntoma**: Error 404 "User not found"
  **Soluci√≥n**: Completar el flujo OAuth (requests 02-03)

  ## Scripts autom√°ticos

  - **Pre-request**: Calcula horarios din√°micos y valida configuraci√≥n
  - **Post-response**: Muestra resumen detallado del evento creado
  - **Tests**: Valida estructura completa de la respuesta y metadatos

  ## Variables guardadas

  Despu√©s de crear un evento exitosamente, se guardan:
  - `last_created_event_id`: ID del evento para referencias futuras
  - `last_created_event_link`: Enlace directo a Google Calendar
}
